# AI機能強化 - 要件定義書

## 📋 概要

SightEditのAI機能を大幅に強化し、チャット機能、高度な文章生成、カスタムプロンプト管理、会話履歴保存を追加する。

### 目的
- **現状**: 基本的なAI執筆支援（要約、校正、翻訳など）のみ
- **課題**:
  - 対話型のAI支援がない
  - カスタムプロンプトが保存できない
  - 会話履歴が残らない
  - 文章生成機能が限定的
- **目標**: フル機能のAI執筆アシスタントを実現

## 🎯 機能要件

### 1. AIチャット機能

#### 1.1 チャットUI
- **チャットパネル**: エディター右側または下部に配置可能な独立パネル
- **会話履歴表示**: メッセージの時系列表示（ユーザー/AI）
- **メッセージ入力欄**: マルチラインテキストエリア + 送信ボタン
- **コンテキスト連携**: 現在編集中のドキュメントを自動でコンテキストとして送信（オプション）

#### 1.2 チャット機能
```javascript
チャット機能:
- テキストメッセージ送信
- ストリーミング応答表示（リアルタイムで表示）
- Markdown形式での応答表示
- コードブロックのシンタックスハイライト
- 応答のコピー/エディターへ挿入
- 会話のクリア/新規開始
```

#### 1.3 コンテキスト管理
```javascript
コンテキストオプション:
- ドキュメント全体を含める
- 選択範囲のみを含める
- コンテキストなし（一般的な会話）
- システムプロンプトのカスタマイズ
```

### 2. 高度な文章生成機能

#### 2.1 文章生成モード
```javascript
生成モード:
- 続きを書く: カーソル位置から文章を続ける
- 書き直す: 選択テキストを改善して書き直す
- 展開する: 短い文章を詳細に展開
- 要約する: 長い文章を簡潔に要約
- アウトライン生成: トピックから構造化された文章を生成
- パラフレーズ: 同じ意味で異なる表現に変換
```

#### 2.2 スタイル制御
```javascript
文体オプション:
- トーン: フォーマル/カジュアル/技術的/クリエイティブ
- 長さ: 短い/標準/長い/カスタム（文字数指定）
- 対象読者: 一般/専門家/初心者/子供向け
- 言語: 日本語/英語/多言語
```

#### 2.3 構造化生成
```javascript
構造化オプション:
- ブログ記事: タイトル + 導入 + 本文 + まとめ
- 技術文書: 概要 + 仕様 + 実装 + 例
- プレゼン: スライド構成の提案
- 論文: アブストラクト + イントロ + 本文 + 結論
```

### 3. カスタムプロンプト機能

#### 3.1 プロンプトテンプレート管理
```javascript
プロンプト管理:
- プロンプトの作成/編集/削除
- カテゴリー分類（執筆支援/コーディング/翻訳/etc）
- お気に入り登録
- 使用頻度でのソート
- プロンプトのインポート/エクスポート
```

#### 3.2 プロンプトテンプレート構造
```javascript
interface PromptTemplate {
  id: string;
  name: string;
  description: string;
  category: string;
  prompt: string;
  variables: Array<{
    name: string;
    type: 'text' | 'number' | 'select';
    description: string;
    defaultValue?: string;
    options?: string[]; // selectの場合
  }>;
  createdAt: number;
  lastUsed: number;
  usageCount: number;
  isFavorite: boolean;
}
```

#### 3.3 プロンプト実行
```javascript
実行機能:
- 変数の動的置換（{{variable}}形式）
- プレビュー機能
- クイック実行（ワンクリック）
- ショートカットキー割り当て
```

#### 3.4 プロンプトライブラリ
```javascript
デフォルトプロンプト集:
- ブログ記事作成
- SEO最適化
- コードレビュー
- バグ修正提案
- ドキュメント生成
- 要約（様々なスタイル）
- 翻訳（様々な言語ペア）
- 文体変換
```

### 4. AI会話履歴管理

#### 4.1 会話セッション
```javascript
セッション管理:
- 自動保存: すべての会話を自動で保存
- セッション一覧: 日付・タイトルで管理
- セッション検索: キーワード検索
- セッション復元: 過去の会話を再開
- セッション削除: 不要な会話を削除
```

#### 4.2 会話データ構造
```javascript
interface ChatSession {
  id: string;
  title: string; // 自動生成または手動設定
  createdAt: number;
  updatedAt: number;
  messages: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp: number;
  }>;
  model: string;
  provider: string;
  tags: string[];
}
```

#### 4.3 履歴機能
```javascript
履歴機能:
- タイトル自動生成（会話の最初のメッセージから）
- タグ付け（カテゴリー分類）
- エクスポート（JSON/Markdown）
- インポート（他のセッションから）
- お気に入り登録
```

#### 4.4 ストレージ
```javascript
保存方法:
- Chrome Storage: 軽量な最近の履歴（直近50件）
- IndexedDB: 大量の履歴データ（無制限）
- エクスポート: ファイルとして保存可能
```

### 5. UI/UX要件

#### 5.1 レイアウト
```
┌──────────────────────────────────────┐
│ Toolbar                              │
├───────────────────┬──────────────────┤
│                   │ Chat Panel       │
│  Editor           │ ┌──────────────┐ │
│                   │ │ History      │ │
│                   │ ├──────────────┤ │
│                   │ │ Messages     │ │
│                   │ │              │ │
│                   │ │              │ │
│                   │ └──────────────┘ │
│                   │ [Input  ] [送信] │
└───────────────────┴──────────────────┘
```

#### 5.2 チャットパネル機能
```javascript
パネル制御:
- トグル表示/非表示
- リサイズ可能
- 位置変更（右/下/フローティング）
- 折りたたみ/展開
- 全画面モード
```

#### 5.3 キーボードショートカット
```javascript
ショートカット:
- Ctrl+K: チャットパネルのトグル
- Ctrl+Enter: メッセージ送信
- Ctrl+L: 会話クリア
- Ctrl+P: プロンプトライブラリを開く
- Ctrl+H: 履歴を開く
```

### 6. AIプロバイダー統合

#### 6.1 既存API拡張
```javascript
追加機能:
- ストリーミング対応（Gemini/Claude両方）
- システムプロンプト設定
- 温度・Top-Pパラメータ調整
- トークン数カウント
- レート制限管理
```

#### 6.2 マルチターン会話
```javascript
会話管理:
- 会話履歴をAPIに送信
- コンテキストウィンドウ管理
- 古いメッセージの自動削除（トークン制限）
- 要約による圧縮
```

### 7. パフォーマンス要件

```javascript
性能目標:
- チャットパネル開閉: <100ms
- メッセージ送信: <500ms（ストリーミング開始まで）
- 履歴読み込み: <200ms
- プロンプト検索: <100ms
- IndexedDB操作: <300ms
```

### 8. データ管理要件

#### 8.1 ストレージ構造
```javascript
Chrome Storage (sync):
- プロンプトテンプレート（<100KB）
- お気に入り設定

Chrome Storage (local):
- AI設定（既存）
- 最近の会話セッション（直近10件）

IndexedDB:
- すべての会話履歴
- プロンプトテンプレート（バックアップ）
```

#### 8.2 データサイズ制限
```javascript
制限:
- 単一セッション: 最大10MB
- 総IndexedDB: 最大50MB（自動クリーンアップ）
- プロンプトテンプレート: 最大1000個
```

## 🔒 セキュリティ要件

### プライバシー
- 会話データはローカルのみ保存
- APIキーの安全な管理（既存実装を継承）
- センシティブな会話の削除機能
- エクスポート時の暗号化オプション

### エラーハンドリング
- ネットワークエラー時の再試行
- APIレート制限の通知
- 不正なプロンプトの検出

## 📊 成功指標

### 機能性
- ✅ チャット機能が正常に動作
- ✅ 会話履歴が正しく保存・復元される
- ✅ カスタムプロンプトが管理できる
- ✅ ストリーミング応答が表示される

### パフォーマンス
- ✅ UI操作が滑らか（<100ms）
- ✅ 大量の履歴でも高速検索
- ✅ メモリ使用量 <100MB

### ユーザビリティ
- ✅ 直感的なUI
- ✅ キーボードショートカット
- ✅ エラーメッセージが分かりやすい

## 🚀 開発優先順位

### Phase 1: コア機能（必須）
1. チャットUI実装
2. 基本的な会話機能
3. 会話履歴の保存・復元
4. ストリーミング応答

### Phase 2: 拡張機能（重要）
5. カスタムプロンプト管理
6. 文章生成モード
7. プロンプトライブラリ
8. 履歴検索

### Phase 3: 高度な機能（推奨）
9. コンテキスト管理
10. スタイル制御
11. 構造化生成
12. エクスポート/インポート

## 🔗 関連ファイル

### 新規作成
- `src/lib/ai-chat-manager.js` - チャット機能管理
- `src/lib/prompt-manager.js` - プロンプトテンプレート管理
- `src/lib/chat-storage.js` - IndexedDB会話履歴管理
- `src/lib/streaming-handler.js` - ストリーミング応答処理
- `src/editor/chat-panel.js` - チャットUIコンポーネント
- `src/editor/prompt-library.js` - プロンプトライブラリUI

### 拡張
- `src/lib/ai-manager.js` - ストリーミング対応、マルチターン会話
- `src/editor/editor.html` - チャットパネル追加
- `manifest.json` - IndexedDB権限追加

## 📝 備考

- 既存のAI機能との互換性を維持
- TipTapエディターとの統合を考慮（※コメント: 実際にはsimple-editor.jsを使用）
- Chrome拡張のManifest V3制約を考慮
- バンドルサイズの増加を最小限に抑える
