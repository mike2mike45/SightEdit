# AIæ©Ÿèƒ½å¼·åŒ– - è¨­è¨ˆæ›¸

## ğŸ“ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SightEdit Editor                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚                       â”‚
â”‚  Editor Core                    â”‚  AI Chat Panel        â”‚
â”‚  (simple-editor.js)             â”‚  (chat-panel.js)      â”‚
â”‚                                 â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Markdown Editor           â”‚  â”‚  â”‚ Chat History    â”‚ â”‚
â”‚  â”‚                           â”‚  â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚                           â”‚  â”‚  â”‚ â— User: ...     â”‚ â”‚
â”‚  â”‚                           â”‚  â”‚  â”‚ â—‹ AI: ...       â”‚ â”‚
â”‚  â”‚                           â”‚  â”‚  â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                 â”‚  â”‚ Input Box       â”‚ â”‚
â”‚                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                              â”‚
        â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI Manager      â”‚                    â”‚  Prompt Manager     â”‚
â”‚ (ai-manager.js)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (prompt-manager.js) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                              â”‚
        â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Streaming Handler â”‚                    â”‚  Chat Storage       â”‚
â”‚(streaming-handler)â”‚                    â”‚ (chat-storage.js)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                              â”‚
        â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Chrome Extension APIs                             â”‚
â”‚  â€¢ Chrome Storage (sync/local)  â€¢ IndexedDB  â€¢ Fetch API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
User Input
    â”‚
    â–¼
Chat Panel â”€â”€â–º Prompt Manager (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨)
    â”‚               â”‚
    â–¼               â–¼
AI Manager â—„â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â–º Streaming Handler (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º)
    â”‚         â”‚
    â”‚         â–¼
    â”‚    Chat Panel (è¡¨ç¤ºæ›´æ–°)
    â”‚
    â–¼
Chat Storage (å±¥æ­´ä¿å­˜)
    â”‚
    â”œâ”€â”€â–º Chrome Storage (æœ€è¿‘ã®å±¥æ­´)
    â””â”€â”€â–º IndexedDB (å…¨å±¥æ­´)
```

## ğŸ—ï¸ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ

### 1. AI Chat Manager (`src/lib/ai-chat-manager.js`)

ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ä¸­æ ¸ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

```javascript
export class AIChatManager {
    constructor(aiManager, promptManager, chatStorage) {
        this.aiManager = aiManager;
        this.promptManager = promptManager;
        this.chatStorage = chatStorage;
        this.currentSession = null;
        this.isStreaming = false;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
    async createNewSession(title = null) {
        // æ–°ã—ã„ä¼šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    }

    async loadSession(sessionId) {
        // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
    }

    async saveSession() {
        // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async sendMessage(content, options = {}) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã€AIå¿œç­”ã‚’å–å¾—
        // options: { includeContext, contextType, streaming }
    }

    async sendMessageWithStreaming(content, onChunk, onComplete) {
        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    }

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
    getEditorContext(type = 'full') {
        // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®å†…å®¹ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å–å¾—
        // type: 'full' | 'selection' | 'none'
    }

    buildMessages(userContent, includeContext) {
        // APIã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’æ§‹ç¯‰
    }

    // å±¥æ­´ç®¡ç†
    async getSessions() {
        // ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    }

    async deleteSession(sessionId) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    }

    async searchSessions(query) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
    }
}
```

### 2. Prompt Manager (`src/lib/prompt-manager.js`)

ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†ã€‚

```javascript
export class PromptManager {
    constructor() {
        this.templates = [];
        this.categories = ['åŸ·ç­†æ”¯æ´', 'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°', 'ç¿»è¨³', 'ãã®ä»–'];
    }

    // CRUDæ“ä½œ
    async loadTemplates() {
        // Chrome Storageã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
    }

    async saveTemplate(template) {
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
    }

    async updateTemplate(id, updates) {
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°
    }

    async deleteTemplate(id) {
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤
    }

    // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    getTemplatesByCategory(category) {
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
    }

    getFavorites() {
        // ãŠæ°—ã«å…¥ã‚Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
    }

    searchTemplates(query) {
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®Ÿè¡Œ
    applyTemplate(templateId, variables = {}) {
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¤‰æ•°ã‚’é©ç”¨ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        // ä¾‹: "{{text}}ã‚’è¦ç´„ã—ã¦" â†’ "ã“ã‚“ã«ã¡ã¯ã‚’è¦ç´„ã—ã¦"
    }

    parseVariables(promptText) {
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰å¤‰æ•°ã‚’æŠ½å‡º
        // ä¾‹: "{{text}}" â†’ ['text']
    }

    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    async exportTemplates() {
        // JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    }

    async importTemplates(jsonData) {
        // JSONå½¢å¼ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    getDefaultTemplates() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿”ã™
    }
}
```

### 3. Chat Storage (`src/lib/chat-storage.js`)

IndexedDBã‚’ä½¿ç”¨ã—ãŸä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–ã€‚

```javascript
export class ChatStorage {
    constructor() {
        this.dbName = 'SightEditChatDB';
        this.dbVersion = 1;
        this.db = null;
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
    async initDB() {
        // IndexedDBã‚’åˆæœŸåŒ–
        // Object Stores: sessions, messages
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ“ä½œ
    async saveSession(session) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
    }

    async getSession(sessionId) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    }

    async getAllSessions() {
        // ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    }

    async deleteSession(sessionId) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    }

    async updateSession(sessionId, updates) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¿ã‚°ãªã©ï¼‰
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ“ä½œ
    async addMessage(sessionId, message) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    }

    async getMessages(sessionId) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    }

    // æ¤œç´¢
    async searchSessions(query) {
        // ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¿ã‚°ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã§æ¤œç´¢
    }

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
    async getStorageSize() {
        // ä½¿ç”¨ä¸­ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å–å¾—
    }

    async cleanup(maxSessions = 100) {
        // å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æœ€é©åŒ–
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    async exportSession(sessionId, format = 'json') {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSON/Markdownï¼‰
    }
}
```

### 4. Streaming Handler (`src/lib/streaming-handler.js`)

Server-Sent Eventsã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”å‡¦ç†ã€‚

```javascript
export class StreamingHandler {
    constructor() {
        this.abortController = null;
    }

    // Gemini ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    async streamGemini(endpoint, apiKey, requestBody, onChunk, onComplete, onError) {
        // Gemini API ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
        // ?alt=sse ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§SSEå½¢å¼ã®å¿œç­”ã‚’å–å¾—
    }

    // Claude ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    async streamClaude(endpoint, apiKey, requestBody, onChunk, onComplete, onError) {
        // Claude API ã® streaming: true ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        // Server-Sent Eventså½¢å¼ã§å¿œç­”ã‚’å—ä¿¡
    }

    // å…±é€šã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
    async processStream(reader, onChunk, onComplete, onError) {
        // ReadableStreamã‹ã‚‰ãƒãƒ£ãƒ³ã‚¯ã‚’èª­ã¿å–ã‚Š
        // ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ onChunk ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—
    }

    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­æ–­
    abort() {
        // é€²è¡Œä¸­ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’ä¸­æ–­
    }

    // SSE ãƒ‘ãƒ¼ã‚µãƒ¼
    parseSSE(chunk) {
        // Server-Sent Eventså½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
    }
}
```

### 5. Chat Panel UI (`src/editor/chat-panel.js`)

ãƒãƒ£ãƒƒãƒˆUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚

```javascript
export class ChatPanel {
    constructor(chatManager, promptManager) {
        this.chatManager = chatManager;
        this.promptManager = promptManager;
        this.element = null;
        this.isVisible = false;
        this.position = 'right'; // 'right' | 'bottom' | 'floating'
    }

    // UIåˆæœŸåŒ–
    render() {
        // ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã®HTMLã‚’ç”Ÿæˆ
    }

    // è¡¨ç¤ºåˆ¶å¾¡
    show() {}
    hide() {}
    toggle() {}

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    setPosition(position) {
        // ãƒ‘ãƒãƒ«ã®ä½ç½®ã‚’å¤‰æ›´
    }

    resize(width, height) {
        // ãƒ‘ãƒãƒ«ã®ã‚µã‚¤ã‚ºå¤‰æ›´
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    addMessage(role, content, streaming = false) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ è¡¨ç¤º
    }

    updateStreamingMessage(content) {
        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    }

    renderMessage(message) {
        // Markdownå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’HTMLã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†UI
    showSessionList() {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
    }

    loadSession(sessionId) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    }

    clearChat() {
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    setupEventListeners() {
        // é€ä¿¡ãƒœã‚¿ãƒ³ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãªã©
    }

    onSendMessage() {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã®å‡¦ç†
    }

    onCopyMessage(messageElement) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ”ãƒ¼
    }

    onInsertToEditor(messageElement) {
        // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¸ã®æŒ¿å…¥
    }
}
```

### 6. Prompt Library UI (`src/editor/prompt-library.js`)

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®UIã€‚

```javascript
export class PromptLibrary {
    constructor(promptManager) {
        this.promptManager = promptManager;
        this.element = null;
    }

    // UIè¡¨ç¤º
    show() {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¡¨ç¤º
    }

    render() {
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒªã‚¹ãƒˆã®HTMLã‚’ç”Ÿæˆ
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥è¡¨ç¤º
    renderByCategory() {}

    // ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤º
    renderFavorites() {}

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†
    showEditDialog(templateId = null) {
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ/ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    }

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œ
    executePrompt(templateId) {
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡
    }

    // å¤‰æ•°å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    showVariableInputDialog(variables) {
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã®å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    }
}
```

### 7. AI Manageræ‹¡å¼µ (`src/lib/ai-manager.js`)

æ—¢å­˜ã®AIManagerã‚¯ãƒ©ã‚¹ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã€‚

```javascript
// è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰

async callAIWithStreaming(messages, onChunk, onComplete, onError) {
    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§AIã‚’å‘¼ã³å‡ºã—
    const provider = this.settings.aiProvider;
    const streamingHandler = new StreamingHandler();

    if (provider === 'gemini') {
        await streamingHandler.streamGemini(/*...*/);
    } else if (provider === 'claude') {
        await streamingHandler.streamClaude(/*...*/);
    }
}

buildChatMessages(messages) {
    // ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³ä¼šè©±ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’æ§‹ç¯‰
    // Geminiå½¢å¼: [{role: 'user', parts: [{text: '...'}]}]
    // Claudeå½¢å¼: [{role: 'user', content: '...'}]
}

manageTokenLimit(messages, maxTokens) {
    // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æ•´
    // å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã¾ãŸã¯è¦ç´„
}
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ

### Chat Session

```typescript
interface ChatSession {
    id: string;                  // UUID
    title: string;               // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
    createdAt: number;           // ä½œæˆæ—¥æ™‚ï¼ˆUnix timestampï¼‰
    updatedAt: number;           // æ›´æ–°æ—¥æ™‚
    messages: ChatMessage[];     // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—
    model: string;               // ä½¿ç”¨ã—ãŸãƒ¢ãƒ‡ãƒ«
    provider: 'gemini' | 'claude'; // AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
    tags: string[];              // ã‚¿ã‚°
    isFavorite: boolean;         // ãŠæ°—ã«å…¥ã‚Š
    contextType: 'full' | 'selection' | 'none'; // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚¤ãƒ—
}
```

### Chat Message

```typescript
interface ChatMessage {
    id: string;                  // UUID
    role: 'user' | 'assistant';  // é€ä¿¡è€…
    content: string;             // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
    timestamp: number;           // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    metadata?: {
        tokens?: number;         // ãƒˆãƒ¼ã‚¯ãƒ³æ•°
        model?: string;          // ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«
        context?: string;        // å«ã¾ã‚Œã¦ã„ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    };
}
```

### Prompt Template

```typescript
interface PromptTemplate {
    id: string;                  // UUID
    name: string;                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå
    description: string;         // èª¬æ˜
    category: string;            // ã‚«ãƒ†ã‚´ãƒªãƒ¼
    prompt: string;              // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆï¼ˆ{{variable}}å½¢å¼ï¼‰
    variables: PromptVariable[]; // å¤‰æ•°å®šç¾©
    createdAt: number;           // ä½œæˆæ—¥æ™‚
    lastUsed: number;            // æœ€çµ‚ä½¿ç”¨æ—¥æ™‚
    usageCount: number;          // ä½¿ç”¨å›æ•°
    isFavorite: boolean;         // ãŠæ°—ã«å…¥ã‚Š
}
```

### Prompt Variable

```typescript
interface PromptVariable {
    name: string;                // å¤‰æ•°å
    type: 'text' | 'number' | 'select'; // å‹
    description: string;         // èª¬æ˜
    defaultValue?: string;       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    options?: string[];          // selectã®é¸æŠè‚¢
    required: boolean;           // å¿…é ˆãƒ•ãƒ©ã‚°
}
```

## ğŸ¨ UI/UXè¨­è¨ˆ

### Chat Panel ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```html
<div class="chat-panel" data-position="right">
    <!-- Header -->
    <div class="chat-panel-header">
        <div class="header-left">
            <button class="btn-icon" id="chat-sessions">
                <span class="icon">ğŸ“‹</span>
                <span>å±¥æ­´</span>
            </button>
            <button class="btn-icon" id="chat-prompts">
                <span class="icon">ğŸ“</span>
                <span>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</span>
            </button>
        </div>
        <div class="header-right">
            <button class="btn-icon" id="chat-settings">âš™ï¸</button>
            <button class="btn-icon" id="chat-minimize">âˆ’</button>
            <button class="btn-icon" id="chat-close">Ã—</button>
        </div>
    </div>

    <!-- Context Options -->
    <div class="context-options">
        <label>
            <input type="radio" name="context" value="none" checked>
            ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãªã—
        </label>
        <label>
            <input type="radio" name="context" value="selection">
            é¸æŠç¯„å›²
        </label>
        <label>
            <input type="radio" name="context" value="full">
            ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“
        </label>
    </div>

    <!-- Messages Container -->
    <div class="chat-messages" id="chat-messages">
        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
        <textarea
            id="chat-input"
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (Ctrl+Enter ã§é€ä¿¡)"
            rows="3"
        ></textarea>
        <div class="input-actions">
            <button class="btn-secondary" id="chat-clear">ã‚¯ãƒªã‚¢</button>
            <button class="btn-primary" id="chat-send">é€ä¿¡</button>
        </div>
    </div>
</div>
```

### Message Component

```html
<!-- User Message -->
<div class="message message-user">
    <div class="message-header">
        <span class="message-role">ã‚ãªãŸ</span>
        <span class="message-time">14:30</span>
    </div>
    <div class="message-content">
        <p>ã“ã®æ–‡ç« ã‚’è¦ç´„ã—ã¦ãã ã•ã„</p>
    </div>
</div>

<!-- AI Message -->
<div class="message message-assistant">
    <div class="message-header">
        <span class="message-role">AI (Gemini 2.5 Pro)</span>
        <span class="message-time">14:30</span>
    </div>
    <div class="message-content markdown-content">
        <!-- Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    </div>
    <div class="message-actions">
        <button class="btn-icon" data-action="copy">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-icon" data-action="insert">â• æŒ¿å…¥</button>
        <button class="btn-icon" data-action="regenerate">ğŸ”„ å†ç”Ÿæˆ</button>
    </div>
</div>

<!-- Streaming Message -->
<div class="message message-assistant streaming">
    <div class="message-header">
        <span class="message-role">AI (Claude 3.5 Sonnet)</span>
        <span class="message-time">14:31</span>
    </div>
    <div class="message-content markdown-content">
        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <span class="typing-indicator">â–Š</span>
    </div>
    <div class="message-actions">
        <button class="btn-icon" data-action="stop">â¹ï¸ åœæ­¢</button>
    </div>
</div>
```

### Session List

```html
<div class="session-list-modal">
    <div class="modal-header">
        <h3>ä¼šè©±å±¥æ­´</h3>
        <button class="close-btn">Ã—</button>
    </div>
    <div class="modal-content">
        <div class="session-filters">
            <input type="search" placeholder="æ¤œç´¢...">
            <select>
                <option value="all">ã™ã¹ã¦</option>
                <option value="favorites">ãŠæ°—ã«å…¥ã‚Š</option>
                <option value="today">ä»Šæ—¥</option>
                <option value="week">ä»Šé€±</option>
            </select>
        </div>
        <div class="session-items">
            <div class="session-item" data-session-id="xxx">
                <div class="session-info">
                    <h4 class="session-title">æ–‡ç« ã®è¦ç´„ã«ã¤ã„ã¦</h4>
                    <p class="session-preview">ã“ã®æ–‡ç« ã‚’è¦ç´„ã—ã¦ãã ã•ã„...</p>
                    <span class="session-date">2024-01-15 14:30</span>
                </div>
                <div class="session-actions">
                    <button data-action="load">é–‹ã</button>
                    <button data-action="favorite">â­</button>
                    <button data-action="delete">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>
    </div>
</div>
```

### Prompt Library

```html
<div class="prompt-library-modal">
    <div class="modal-header">
        <h3>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
        <button class="btn-primary" id="new-prompt">+ æ–°è¦ä½œæˆ</button>
        <button class="close-btn">Ã—</button>
    </div>
    <div class="modal-content">
        <div class="prompt-sidebar">
            <ul class="category-list">
                <li class="active">ã™ã¹ã¦</li>
                <li>ãŠæ°—ã«å…¥ã‚Š</li>
                <li>åŸ·ç­†æ”¯æ´</li>
                <li>ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</li>
                <li>ç¿»è¨³</li>
                <li>ãã®ä»–</li>
            </ul>
        </div>
        <div class="prompt-main">
            <input type="search" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¤œç´¢...">
            <div class="prompt-grid">
                <div class="prompt-card">
                    <div class="prompt-header">
                        <h4>ãƒ–ãƒ­ã‚°è¨˜äº‹ä½œæˆ</h4>
                        <span class="favorite">â­</span>
                    </div>
                    <p class="prompt-description">
                        ãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’ç”Ÿæˆ
                    </p>
                    <div class="prompt-meta">
                        <span>ğŸ“‚ åŸ·ç­†æ”¯æ´</span>
                        <span>ğŸ”¢ ä½¿ç”¨: 25å›</span>
                    </div>
                    <div class="prompt-actions">
                        <button data-action="execute">å®Ÿè¡Œ</button>
                        <button data-action="edit">ç·¨é›†</button>
                        <button data-action="delete">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

## ğŸ”Œ APIè¨­è¨ˆ

### Gemini Streaming API

```javascript
// ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?key=${apiKey}&alt=sse`;

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const requestBody = {
    contents: [
        {
            role: 'user',
            parts: [{ text: 'ã“ã‚“ã«ã¡ã¯' }]
        },
        {
            role: 'model',
            parts: [{ text: 'ã“ã‚“ã«ã¡ã¯ï¼' }]
        },
        {
            role: 'user',
            parts: [{ text: 'å…ƒæ°—ã§ã™ã‹ï¼Ÿ' }]
        }
    ],
    generationConfig: {
        temperature: 0.7,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 8192
    }
};

// SSEå¿œç­”å½¢å¼
// data: {"candidates":[{"content":{"parts":[{"text":"å…ƒæ°—"}]}}]}
// data: {"candidates":[{"content":{"parts":[{"text":"ã§ã™"}]}}]}
// data: [DONE]
```

### Claude Streaming API

```javascript
// ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const endpoint = 'https://api.anthropic.com/v1/messages';

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const requestBody = {
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 8192,
    stream: true,  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æœ‰åŠ¹åŒ–
    messages: [
        {
            role: 'user',
            content: 'ã“ã‚“ã«ã¡ã¯'
        },
        {
            role: 'assistant',
            content: 'ã“ã‚“ã«ã¡ã¯ï¼'
        },
        {
            role: 'user',
            content: 'å…ƒæ°—ã§ã™ã‹ï¼Ÿ'
        }
    ]
};

// ãƒ˜ãƒƒãƒ€ãƒ¼
const headers = {
    'Content-Type': 'application/json',
    'x-api-key': apiKey,
    'anthropic-version': '2023-06-01'
};

// SSEå¿œç­”å½¢å¼
// event: message_start
// data: {"type":"message_start","message":{"id":"msg_xxx"}}
//
// event: content_block_delta
// data: {"type":"content_block_delta","delta":{"type":"text_delta","text":"å…ƒæ°—"}}
//
// event: content_block_delta
// data: {"type":"content_block_delta","delta":{"type":"text_delta","text":"ã§ã™"}}
//
// event: message_stop
// data: {"type":"message_stop"}
```

## ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ

### Chrome Storage (sync)

```javascript
// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆåŒæœŸï¼‰
chrome.storage.sync.set({
    promptTemplates: [
        {
            id: 'template-1',
            name: 'ãƒ–ãƒ­ã‚°è¨˜äº‹ä½œæˆ',
            prompt: '{{topic}}ã«ã¤ã„ã¦ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„',
            // ...
        }
    ]
});

// åˆ¶é™: æœ€å¤§100KB
```

### Chrome Storage (local)

```javascript
// æœ€è¿‘ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
chrome.storage.local.set({
    recentSessions: [
        {
            id: 'session-1',
            title: 'æ–‡ç« ã®è¦ç´„',
            updatedAt: 1705308600000,
            // æœ€æ–°10ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿
            messages: [/* ... */]
        }
    ]
});

// åˆ¶é™: æœ€å¤§10MB
```

### IndexedDB

```javascript
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 
const dbSchema = {
    name: 'SightEditChatDB',
    version: 1,
    stores: [
        {
            name: 'sessions',
            keyPath: 'id',
            indexes: [
                { name: 'createdAt', keyPath: 'createdAt' },
                { name: 'updatedAt', keyPath: 'updatedAt' },
                { name: 'title', keyPath: 'title' },
                { name: 'tags', keyPath: 'tags', multiEntry: true }
            ]
        },
        {
            name: 'messages',
            keyPath: 'id',
            indexes: [
                { name: 'sessionId', keyPath: 'sessionId' },
                { name: 'timestamp', keyPath: 'timestamp' }
            ]
        },
        {
            name: 'promptTemplates',
            keyPath: 'id',
            indexes: [
                { name: 'category', keyPath: 'category' },
                { name: 'lastUsed', keyPath: 'lastUsed' },
                { name: 'usageCount', keyPath: 'usageCount' }
            ]
        }
    ]
};

// åˆ¶é™: ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ï¼ˆé€šå¸¸50MBã€œç„¡åˆ¶é™ï¼‰
```

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å„ªå…ˆé †ä½

```javascript
// ãƒ‡ãƒ¼ã‚¿é…ç½®æˆ¦ç•¥
const storageStrategy = {
    // Chrome Storage Sync: å°ã•ã„ã€é‡è¦ã€åŒæœŸãŒå¿…è¦
    sync: [
        'promptTemplates',  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        'favorites',        // ãŠæ°—ã«å…¥ã‚Š
        'settings'          // è¨­å®š
    ],

    // Chrome Storage Local: ä¸­ç¨‹åº¦ã€é«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹å¿…è¦
    local: [
        'recentSessions',   // æœ€è¿‘ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ10ä»¶ï¼‰
        'aiSettings',       // AIè¨­å®š
        'uiState'           // UIçŠ¶æ…‹
    ],

    // IndexedDB: å¤§ãã„ã€å…¨å±¥æ­´
    indexedDB: [
        'allSessions',      // ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
        'allMessages',      // ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        'backupTemplates'   // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    ]
};
```

## ğŸ”„ æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®çµ±åˆ

### Editorçµ±åˆãƒã‚¤ãƒ³ãƒˆ

```javascript
// editor.html ã«è¿½åŠ 
<div id="chat-panel-container"></div>

// simple-editor.js ã¾ãŸã¯æ–°ã—ã„ editor-init.js
import { ChatPanel } from './chat-panel.js';
import { AIChatManager } from '../lib/ai-chat-manager.js';
import { PromptManager } from '../lib/prompt-manager.js';
import { ChatStorage } from '../lib/chat-storage.js';

// åˆæœŸåŒ–
const chatStorage = new ChatStorage();
await chatStorage.initDB();

const promptManager = new PromptManager();
await promptManager.loadTemplates();

const chatManager = new AIChatManager(
    window.aiManager,  // æ—¢å­˜ã®AIManager
    promptManager,
    chatStorage
);

const chatPanel = new ChatPanel(chatManager, promptManager);
chatPanel.render();

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
window.chatPanel = chatPanel;
window.chatManager = chatManager;
```

### ãƒ„ãƒ¼ãƒ«ãƒãƒ¼çµ±åˆ

```javascript
// ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã«ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
const chatButton = document.createElement('button');
chatButton.className = 'toolbar-btn';
chatButton.innerHTML = 'ğŸ’¬ AI Chat';
chatButton.addEventListener('click', () => {
    window.chatPanel.toggle();
});

toolbar.appendChild(chatButton);
```

### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

```javascript
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
document.addEventListener('keydown', (e) => {
    // Ctrl+K: ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ« ãƒˆã‚°ãƒ«
    if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        window.chatPanel.toggle();
    }

    // Ctrl+P: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        window.promptLibrary.show();
    }

    // Ctrl+H: å±¥æ­´
    if (e.ctrlKey && e.key === 'h') {
        e.preventDefault();
        window.chatPanel.showSessionList();
    }
});
```

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

```javascript
// ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå¤§é‡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼‰
class VirtualScrollMessages {
    constructor(container, messages) {
        this.container = container;
        this.messages = messages;
        this.visibleRange = { start: 0, end: 20 };
    }

    render() {
        // è¡¨ç¤ºç¯„å›²å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const visibleMessages = this.messages.slice(
            this.visibleRange.start,
            this.visibleRange.end
        );
        // ...
    }
}
```

### 2. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æœ€é©åŒ–

```javascript
// ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã—ã¦ãƒãƒƒãƒæ›´æ–°
class StreamBuffer {
    constructor(onFlush, flushInterval = 50) {
        this.buffer = '';
        this.onFlush = onFlush;
        this.timer = null;
        this.flushInterval = flushInterval;
    }

    add(chunk) {
        this.buffer += chunk;

        if (!this.timer) {
            this.timer = setTimeout(() => {
                this.flush();
            }, this.flushInterval);
        }
    }

    flush() {
        if (this.buffer) {
            this.onFlush(this.buffer);
            this.buffer = '';
        }
        this.timer = null;
    }
}
```

### 3. IndexedDBæœ€é©åŒ–

```javascript
// ãƒãƒƒãƒæ›¸ãè¾¼ã¿
async function batchWrite(store, items) {
    const transaction = db.transaction([store], 'readwrite');
    const objectStore = transaction.objectStore(store);

    const promises = items.map(item => {
        return new Promise((resolve, reject) => {
            const request = objectStore.add(item);
            request.onsuccess = resolve;
            request.onerror = reject;
        });
    });

    await Promise.all(promises);
}

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨
async function searchByDate(startDate, endDate) {
    const index = objectStore.index('createdAt');
    const range = IDBKeyRange.bound(startDate, endDate);
    return index.getAll(range);
}
```

### 4. ãƒ¡ãƒ¢ãƒªç®¡ç†

```javascript
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®åˆ¶é™
const MAX_MESSAGES_IN_MEMORY = 100;

function trimMessages(messages) {
    if (messages.length > MAX_MESSAGES_IN_MEMORY) {
        // æœ€æ–°100ä»¶ã®ã¿ãƒ¡ãƒ¢ãƒªã«ä¿æŒ
        return messages.slice(-MAX_MESSAGES_IN_MEMORY);
    }
    return messages;
}

// å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
async function archiveOldSessions() {
    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
    const sessions = await chatStorage.getAllSessions();

    const oldSessions = sessions.filter(s =>
        s.updatedAt < thirtyDaysAgo && !s.isFavorite
    );

    // IndexedDBã‹ã‚‰Chrome Storageã‚’å‰Šé™¤
    for (const session of oldSessions) {
        await removeFromLocalStorage(session.id);
    }
}
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. XSSå¯¾ç­–

```javascript
// Markdown ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
import { marked } from 'marked';
import DOMPurify from 'dompurify';  // è¿½åŠ ä¾å­˜é–¢ä¿‚

function renderSafeMarkdown(markdown) {
    const html = marked.parse(markdown);
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'code', 'pre', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'blockquote'],
        ALLOWED_ATTR: ['href', 'class']
    });
}
```

### 2. ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```javascript
// æ•æ„Ÿãªä¼šè©±ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«æš—å·åŒ–
async function exportEncrypted(sessionId, password) {
    const session = await chatStorage.getSession(sessionId);
    const json = JSON.stringify(session);

    // Web Crypto API ã§æš—å·åŒ–
    const encrypted = await encryptData(json, password);
    return encrypted;
}

async function encryptData(data, password) {
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ã‚­ãƒ¼ã‚’ç”Ÿæˆ
    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        encoder.encode(password),
        'PBKDF2',
        false,
        ['deriveBits', 'deriveKey']
    );

    const key = await crypto.subtle.deriveKey(
        {
            name: 'PBKDF2',
            salt: encoder.encode('sightedit-salt'),
            iterations: 100000,
            hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt']
    );

    // ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        key,
        dataBuffer
    );

    return { encrypted, iv };
}
```

### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```javascript
// APIå‘¼ã³å‡ºã—ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
class RateLimiter {
    constructor(maxRequests, windowMs) {
        this.maxRequests = maxRequests;
        this.windowMs = windowMs;
        this.requests = [];
    }

    canMakeRequest() {
        const now = Date.now();
        this.requests = this.requests.filter(time =>
            now - time < this.windowMs
        );

        return this.requests.length < this.maxRequests;
    }

    recordRequest() {
        this.requests.push(Date.now());
    }
}

// ä½¿ç”¨ä¾‹
const geminiLimiter = new RateLimiter(60, 60000); // 60req/min
const claudeLimiter = new RateLimiter(50, 60000); // 50req/min
```

## ğŸ“¦ ãƒ“ãƒ«ãƒ‰è¨­å®šæ›´æ–°

### webpack.config.js

```javascript
module.exports = {
    entry: {
        background: './src/background/background.js',
        popup: './src/popup/popup.js',
        editor: './src/editor/simple-editor.js',
        'chat-panel': './src/editor/chat-panel.js',  // è¿½åŠ 
    },
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: '[name].js'
    },
    // ...
};
```

### manifest.json æ›´æ–°

```json
{
    "manifest_version": 3,
    "permissions": [
        "storage",
        "activeTab"
    ],
    "host_permissions": [
        "https://generativelanguage.googleapis.com/*",
        "https://api.anthropic.com/*"
    ],
    "content_security_policy": {
        "extension_pages": "script-src 'self'; object-src 'self'"
    }
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### Unit Tests

```javascript
// tests/unit/chat-storage.test.js
describe('ChatStorage', () => {
    test('should save and retrieve session', async () => {
        const storage = new ChatStorage();
        await storage.initDB();

        const session = {
            id: 'test-1',
            title: 'Test Session',
            messages: []
        };

        await storage.saveSession(session);
        const retrieved = await storage.getSession('test-1');

        expect(retrieved.title).toBe('Test Session');
    });
});

// tests/unit/prompt-manager.test.js
describe('PromptManager', () => {
    test('should apply variables to template', () => {
        const manager = new PromptManager();
        const result = manager.applyTemplate(
            '{{topic}}ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„',
            { topic: 'AI' }
        );

        expect(result).toBe('AIã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„');
    });
});
```

### Integration Tests

```javascript
// tests/integration/chat-flow.test.js
describe('Chat Flow', () => {
    test('should send message and receive response', async () => {
        const chatManager = new AIChatManager(/*...*/);
        await chatManager.createNewSession();

        const response = await chatManager.sendMessage('ã“ã‚“ã«ã¡ã¯');

        expect(response).toBeDefined();
        expect(chatManager.currentSession.messages.length).toBe(2);
    });
});
```

## ğŸ“ é–‹ç™ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ã‚³ã‚¢æ©Ÿèƒ½
- [ ] ChatStorage (IndexedDB) å®Ÿè£…
- [ ] AIChatManager å®Ÿè£…
- [ ] StreamingHandler å®Ÿè£…
- [ ] AIManager æ‹¡å¼µï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰
- [ ] ChatPanel UI å®Ÿè£…
- [ ] åŸºæœ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡
- [ ] ä¼šè©±å±¥æ­´ã®ä¿å­˜ãƒ»å¾©å…ƒ
- [ ] ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”è¡¨ç¤º

### Phase 2: æ‹¡å¼µæ©Ÿèƒ½
- [ ] PromptManager å®Ÿè£…
- [ ] PromptLibrary UI å®Ÿè£…
- [ ] ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆãƒ»ç·¨é›†
- [ ] æ–‡ç« ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰å®Ÿè£…
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢æ©Ÿèƒ½
- [ ] ã‚¿ã‚°ä»˜ã‘æ©Ÿèƒ½

### Phase 3: é«˜åº¦ãªæ©Ÿèƒ½
- [ ] ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
- [ ] ã‚¹ã‚¿ã‚¤ãƒ«åˆ¶å¾¡
- [ ] æ§‹é€ åŒ–ç”Ÿæˆ
- [ ] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- [ ] æš—å·åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

## ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

è¨­è¨ˆæ›¸æ‰¿èªå¾Œã€`tasks.md`ã§ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’è¡Œã„ã€å®Ÿè£…ã«ç§»ã‚Šã¾ã™ã€‚
