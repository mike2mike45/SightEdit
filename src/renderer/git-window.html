<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Git パネル - SightEdit</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="git-styles.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      background: #fff;
      overflow: hidden;
    }
    
    /* Git パネルを全画面表示用に調整 */
    .git-panel {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100% !important;
      height: 100% !important;
      border: none !important;
      box-shadow: none !important;
      display: flex !important;
      flex-direction: column !important;
    }
    
    .git-panel.visible {
      display: flex !important;
    }
    
    .git-panel-header {
      -webkit-app-region: drag; /* ドラッグ可能にする */
      flex-shrink: 0;
    }
    
    .git-panel-header button,
    .git-panel-header input,
    .git-panel-header select {
      -webkit-app-region: no-drag; /* ボタン等はドラッグ不可 */
    }
    
    /* 閉じるボタンを非表示（ウィンドウ自体のボタンを使用） */
    .git-panel-close {
      display: none !important;
    }
    
    .git-panel-content {
      flex: 1;
      overflow-y: auto;
    }
    
    /* ダークテーマ対応 */
    body.dark-theme {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    
    /* ダイアログ関連のスタイル調整 */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <!-- Git パネルのコンテンツはJavaScriptで挿入 -->
  
  <script type="module">
    import { GitPanel } from './git-panel.js';
    import './git-dialogs.js';
    import { GitUIManager } from './git-ui-manager.js';
    
    // Git パネルの初期化
    let gitPanel = null;
    let gitUIManager = null;
    
    async function initGitPanel() {
      console.log('Initializing Git Panel Window...');
      
      // Git パネルのインスタンスを作成
      gitPanel = new GitPanel();
      window.gitPanel = gitPanel;
      
      // GitUIManagerを初期化
      gitUIManager = new GitUIManager(gitPanel);
      window.gitUIManager = gitUIManager;
      
      // 初期テーマを適用
      if (window.electronAPI) {
        try {
          const config = await window.electronAPI.getConfig();
          const theme = config?.theme || 'light';
          if (theme === 'dark') {
            document.body.classList.add('dark-theme');
          }
        } catch (error) {
          console.error('Failed to get theme config:', error);
        }
      }
      
      // テーマ変更の監視
      if (window.electronAPI) {
        window.electronAPI.on('theme-changed', (event, theme) => {
          if (theme === 'dark') {
            document.body.classList.add('dark-theme');
          } else {
            document.body.classList.remove('dark-theme');
          }
        });
      }
      
      // パネルを表示（UIが構築された後）
      setTimeout(() => {
        gitPanel.show();
        console.log('Git Panel shown');
      }, 100);
      
      // メインウィンドウからのメッセージを受信
      if (window.electronAPI) {
        window.electronAPI.on('git-action', (event, action) => {
          console.log('Received git-action:', action);
          if (!gitPanel) return;
          
          switch (action) {
            case 'refresh':
              gitPanel.refreshStatus();
              break;
            case 'stageAll':
              gitPanel.stageAll();
              break;
            case 'commit':
              gitPanel.openCommitDialog();
              break;
            case 'push':
              gitPanel.push();
              break;
            case 'pull':
              gitPanel.pull();
              break;
          }
        });
        
        // リポジトリパス設定
        window.electronAPI.on('git-set-repository', (event, repositoryPath) => {
          console.log('Setting repository path:', repositoryPath);
          if (gitPanel && gitPanel.openRepository) {
            gitPanel.openRepository(repositoryPath);
          }
        });
      }
      
      // ファイル情報取得のダミー関数（Gitウィンドウでは不要だが、互換性のため）
      window.getCurrentFile = () => {
        return { path: null, name: null, saved: true };
      };
      
      // メッセージ表示関数
      window.showMessage = (message, type = 'info') => {
        console.log(`[${type}] ${message}`);
        // TODO: 実際のメッセージ表示実装
      };
    }
    
    // DOMContentLoadedイベントで初期化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGitPanel);
    } else {
      // 既に読み込まれている場合は直接実行
      initGitPanel();
    }
  </script>
</body>
</html>