# プロンプト管理機能 - ユーザーガイド（Phase 2）

## 📋 概要

Phase 2では、カスタムプロンプトテンプレート管理システムを導入しました。これにより、よく使うプロンプトをテンプレートとして保存し、変数を使って柔軟に再利用できます。

## ✨ 主要機能

### 1. プロンプトテンプレート管理
- **CRUD操作**: テンプレートの作成、読み込み、更新、削除
- **変数サポート**: `{{変数名}}` 形式で動的な値を埋め込み
- **カテゴリー分類**: 執筆支援、コーディング、翻訳、その他
- **お気に入り機能**: よく使うテンプレートを素早くアクセス

### 2. デフォルトテンプレートライブラリ
25種類の即使えるテンプレートを提供：
- **執筆支援** (12): ブログ記事、SEO最適化、見出し生成、書き直し、展開、要約、続きを書く、パラフレーズなど
- **コーディング** (5): コードレビュー、バグ修正、リファクタリング、ドキュメント生成、テストコード生成
- **翻訳** (5): 英日翻訳、日英翻訳、ローカライゼーション、技術翻訳、要約翻訳
- **その他** (5): データ分析、Q&A生成、議事録作成、メール作成、プレゼン構成

### 3. プロンプトライブラリUI
- **カテゴリーサイドバー**: カテゴリー別にテンプレートを整理
- **検索機能**: キーワードでテンプレートを素早く検索
- **カードベースのグリッドレイアウト**: 視覚的に見やすいデザイン
- **ダークモード対応**: システム設定に自動対応

### 4. 変数入力システム
- **動的フォーム生成**: テンプレートの変数に基づいてフォームを自動生成
- **変数タイプサポート**: text, textarea, number, select
- **必須/オプション**: 変数ごとに必須・オプションを設定可能
- **バリデーション**: 必須変数の入力チェック

### 5. インポート/エクスポート
- **JSON形式**: テンプレートをJSON形式でエクスポート
- **バックアップ**: テンプレートのバックアップと復元
- **共有**: テンプレートを他のユーザーと共有可能

## 🚀 使い方

### プロンプトライブラリを開く

3つの方法でプロンプトライブラリを開けます：

1. **チャットパネルボタン**: チャットパネルヘッダーの「📝 プロンプト」ボタンをクリック
2. **キーボードショートカット**: `Ctrl+P`（Mac: `Cmd+P`）※チャットパネルが表示されている時のみ
3. **プログラム**: `window.promptLibrary.show()`

### テンプレートを使用する

#### 基本的な使い方

1. プロンプトライブラリを開く
2. カテゴリーまたは検索でテンプレートを見つける
3. テンプレートカードをクリック
4. 変数がある場合は、変数入力ダイアログで値を入力
5. 「確認」ボタンでテンプレートを適用
6. チャット入力欄にプロンプトが挿入される

#### 変数を使ったテンプレート

例: 「ブログ記事作成」テンプレート

```
以下のトピックについて、魅力的なブログ記事を作成してください:

トピック: {{topic}}
対象読者: {{audience}}
文字数: {{word_count}}文字程度

記事には以下を含めてください:
- キャッチーな見出し
- 導入部分
- 本文（複数のセクション）
- まとめ
```

変数入力：
- `topic`: "AIによる生産性向上"
- `audience`: "ビジネスパーソン"
- `word_count`: "2000"

結果：変数が埋め込まれたプロンプトがチャット入力欄に挿入されます。

### 新しいテンプレートを作成

1. プロンプトライブラリを開く
2. 「+ 新規作成」ボタンをクリック
3. テンプレート情報を入力：
   - **名前**: テンプレートの名前
   - **説明**: テンプレートの説明
   - **カテゴリー**: 執筆支援、コーディング、翻訳、その他
   - **プロンプト**: 実際のプロンプト文（`{{変数名}}` で変数を定義）
4. 変数が自動的に検出される
5. 各変数のタイプと説明を設定
6. 「保存」ボタンをクリック

### テンプレートを編集

1. プロンプトライブラリでテンプレートカードを表示
2. カードの「✏️ 編集」ボタンをクリック
3. 情報を編集
4. 「保存」ボタンをクリック

### テンプレートを削除

1. プロンプトライブラリでテンプレートカードを表示
2. カードの「🗑️ 削除」ボタンをクリック
3. 確認ダイアログで「削除」を選択

### テンプレートをお気に入りに追加

1. プロンプトライブラリでテンプレートカードを表示
2. カードの「☆」ボタンをクリック（お気に入りに追加）
3. もう一度クリックすると「⭐」になり、お気に入り解除

### テンプレートを検索

1. プロンプトライブラリの検索ボックスにキーワードを入力
2. テンプレート名、説明、プロンプト内容から検索
3. リアルタイムでフィルタリングされる

### カテゴリーでフィルター

1. サイドバーのカテゴリーをクリック
2. そのカテゴリーのテンプレートのみ表示
3. 「すべて」をクリックするとすべてのテンプレートを表示

### テンプレートをエクスポート

#### すべてエクスポート

1. プロンプトライブラリを開く
2. 「↓ すべてエクスポート」ボタンをクリック
3. JSON形式のファイルがダウンロードされる

#### 選択してエクスポート

1. プロンプトライブラリを開く
2. 「選択してエクスポート」モードを有効化（今後実装予定）
3. エクスポートしたいテンプレートを選択
4. 「エクスポート」ボタンをクリック

### テンプレートをインポート

1. プロンプトライブラリを開く
2. 「↑ インポート」ボタンをクリック
3. JSON形式のファイルを選択
4. インポート結果が表示される
5. 重複するIDのテンプレートは新しいIDで追加される

## 🎨 変数の使い方

### 変数の定義

プロンプト内で `{{変数名}}` の形式で変数を定義します：

```
こんにちは{{name}}さん、今日は{{weather}}ですね。
```

### 変数タイプ

- **text**: 1行のテキスト入力（名前、キーワードなど）
- **textarea**: 複数行のテキスト入力（文章、コードなど）
- **number**: 数値入力（文字数、年齢など）
- **select**: ドロップダウン選択（オプションを指定）

### 変数の設定例

```javascript
variables: [
  {
    name: 'name',
    type: 'text',
    description: 'あなたの名前',
    required: true
  },
  {
    name: 'content',
    type: 'textarea',
    description: '改善したい文章',
    required: true
  },
  {
    name: 'word_count',
    type: 'number',
    description: '目標文字数',
    required: false,
    default: '1000'
  },
  {
    name: 'tone',
    type: 'select',
    description: '文章のトーン',
    options: ['カジュアル', 'フォーマル', '専門的'],
    required: true
  }
]
```

## ⌨️ キーボードショートカット

| ショートカット | 機能 |
|--------------|------|
| `Ctrl+P` / `Cmd+P` | プロンプトライブラリを開く（チャットパネル表示時） |
| `Esc` | プロンプトライブラリを閉じる |

## 💡 使用例

### 例1: ブログ記事を作成

1. `Ctrl+P` でプロンプトライブラリを開く
2. 「ブログ記事作成」テンプレートを選択
3. 変数を入力：
   - トピック: "リモートワークの生産性"
   - 対象読者: "ビジネスパーソン"
   - 文字数: "2000"
4. プロンプトがチャット入力欄に挿入される
5. 送信してAIに記事を生成させる

### 例2: コードレビューを依頼

1. エディターでコードを選択
2. チャットパネルでコンテキストを「選択範囲」に設定
3. `Ctrl+P` でプロンプトライブラリを開く
4. 「コードレビュー」テンプレートを選択
5. プログラミング言語を入力（例: "JavaScript"）
6. 送信してAIにレビューさせる

### 例3: カスタムテンプレートを作成

1. よく使うプロンプトパターンを見つける
2. プロンプトライブラリで「+ 新規作成」
3. テンプレート情報を入力：
   ```
   名前: 技術記事のタイトル案
   カテゴリー: 執筆支援
   プロンプト:
   以下の技術について、魅力的な記事タイトルを5つ提案してください:

   技術: {{technology}}
   対象読者: {{audience}}

   タイトルは以下の要素を含めてください:
   - 具体的な数値や成果
   - 読者の興味を引くキーワード
   - SEOを意識したキーワード
   ```
4. 変数が自動検出される（technology, audience）
5. 各変数のタイプを設定（両方 text, required: true）
6. 保存

### 例4: テンプレートをバックアップ

1. プロンプトライブラリで「↓ すべてエクスポート」
2. `prompt-templates-backup.json` がダウンロードされる
3. 安全な場所に保存
4. 必要に応じて「↑ インポート」で復元

### 例5: 文章を続きを書く

1. エディターで文章を選択
2. チャットパネルでコンテキストを「選択範囲」に設定
3. `Ctrl+P` でプロンプトライブラリを開く
4. 「続きを書く」テンプレートを選択
5. 選択した文章が変数に自動入力される
6. 送信してAIに続きを書かせる

## 🔧 高度な使い方

### プログラムからの操作

#### PromptManager API

```javascript
// テンプレート作成
const template = await window.promptManager.createTemplate({
  name: 'マイテンプレート',
  description: '説明',
  category: '執筆支援',
  prompt: 'これは{{variable}}です',
  variables: [
    { name: 'variable', type: 'text', required: true }
  ]
});

// すべてのテンプレート取得
const templates = await window.promptManager.getAllTemplates();

// カテゴリーでフィルター
const writingTemplates = window.promptManager.getTemplatesByCategory('執筆支援');

// 検索
const results = window.promptManager.searchTemplates('ブログ');

// テンプレート適用
const prompt = window.promptManager.applyTemplate(templateId, {
  variable: '値'
});

// テンプレート更新
await window.promptManager.updateTemplate(templateId, {
  name: '新しい名前'
});

// テンプレート削除
await window.promptManager.deleteTemplate(templateId);

// お気に入り切り替え
await window.promptManager.toggleFavorite(templateId);

// 最近使用したテンプレート
const recent = window.promptManager.getRecentlyUsed(5);

// エクスポート
const exported = window.promptManager.exportTemplates([id1, id2]);

// インポート
const result = await window.promptManager.importTemplates(exportedData);
```

#### PromptLibrary API

```javascript
// ライブラリを表示
window.promptLibrary.show((prompt, template) => {
  console.log('選択されたプロンプト:', prompt);
  console.log('テンプレート:', template.name);
});

// ライブラリを非表示
window.promptLibrary.hide();
```

### カスタム変数バリデーション

テンプレート作成時に、変数の検証ロジックを追加できます：

```javascript
const template = await window.promptManager.createTemplate({
  name: 'カスタム検証',
  prompt: 'メールアドレス: {{email}}',
  variables: [
    {
      name: 'email',
      type: 'text',
      required: true,
      description: 'メールアドレス',
      // カスタム検証は今後実装予定
      validate: (value) => {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      }
    }
  ]
});
```

## 📊 統合テスト

### ブラウザコンソールでのテスト

エディターページを開いて、コンソールで以下を実行：

```javascript
// すべてのPhase 2テストを実行
await runAllPhase2Tests()

// 統合テストのみ
await runPhase2IntegrationTest()

// パフォーマンステストのみ
await runPromptPerformanceTest()

// UI テストのみ
await runPromptUITest()
```

### テスト項目

#### 統合テスト
- ✅ PromptManager 初期化確認
- ✅ デフォルトテンプレート読み込み
- ✅ テンプレート CRUD 操作
- ✅ 変数パース機能
- ✅ テンプレート適用と変数置換
- ✅ カテゴリーフィルタリング
- ✅ 検索機能
- ✅ お気に入り機能
- ✅ エクスポート/インポート機能
- ✅ 最近使用したテンプレート

#### パフォーマンステスト
- ✅ 大量テンプレート作成（100件）
- ✅ 全テンプレート読み込み
- ✅ カテゴリーフィルタリング速度
- ✅ 検索速度
- ✅ テンプレート適用速度（50回）
- ✅ エクスポート速度（100件）
- ✅ インポート速度（100件）

#### UI テスト
- ✅ PromptLibrary 初期化確認
- ✅ ChatPanel との統合確認
- ✅ モーダル表示
- ✅ カテゴリー表示
- ✅ プロンプトカード表示
- ✅ 検索機能

### パフォーマンス基準

| 操作 | 目標時間 |
|------|---------|
| 100件のテンプレート作成 | < 5秒 |
| 全テンプレート読み込み | < 100ms |
| カテゴリーフィルタリング | < 50ms |
| 検索（5回） | < 100ms |
| テンプレート適用（50回） | < 500ms |
| エクスポート（100件） | < 100ms |
| インポート（100件） | < 3秒 |

## 🔒 プライバシーとセキュリティ

- **ローカル保存**: すべてのテンプレートはローカルのChrome Storageに保存されます
- **オフライン利用**: インターネット接続なしでテンプレート管理が可能
- **データ暗号化**: Chrome Storage APIによる自動暗号化
- **エクスポート制御**: ユーザーが明示的にエクスポートした場合のみデータが外部に出る

## 🐛 トラブルシューティング

### プロンプトライブラリが表示されない

1. チャットパネルが表示されているか確認してください
2. ブラウザのコンソールでエラーを確認してください
3. `window.promptManager` と `window.promptLibrary` が存在するか確認してください
4. ページを再読み込みしてください

### テンプレートが保存されない

1. Chrome Storageの容量を確認してください
2. コンソールで `chrome.storage.local.get()` を実行して保存状況を確認
3. ブラウザの設定でストレージが有効か確認してください

### 変数が置換されない

1. 変数名が正確に `{{変数名}}` の形式になっているか確認
2. 変数名にスペースや特殊文字が含まれていないか確認
3. 変数入力ダイアログで値を正しく入力したか確認

### インポートに失敗する

1. JSONファイルの形式が正しいか確認してください
2. ファイルが破損していないか確認してください
3. エクスポート時と同じバージョンのSightEditを使用しているか確認してください

## 🚧 今後の機能（Phase 3）

### 高度な機能
- 構造化生成テンプレート（ブログ記事、技術文書、プレゼン）
- テンプレートのバージョン管理
- テンプレート共有（コミュニティ）
- AI による自動テンプレート提案
- 変数のカスタム検証ルール
- テンプレートのプレビュー機能
- テンプレートのタグ付け
- 使用統計とおすすめテンプレート

## 📝 フィードバック

問題や改善提案がある場合は、GitHubのIssueでお知らせください。

---

**バージョン**: Phase 2.0
**最終更新**: 2025-10-24
